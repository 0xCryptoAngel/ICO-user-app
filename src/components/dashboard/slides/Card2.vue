<template>
  <div class="bg-white rounded-2xl ">
    <div class="p-4 space-y-2">
      <div class="flex">
        <div class="flex items-center space-x-1">
          <img src="@/assets/ETH-logo.png" alt="ETH" class="w-7 h-7"/>
          <img src="@/assets/switch-horizontal.png" alt="switch" class="w-3 h-4"/>
          <img src="@/assets/USD-Coin-icon_small.png" alt="USD" class="w-7 h-7"/>
        </div>
        <div class="ml-2"><strong class="text-xl font-bold ">Ethereum</strong> / USDC</div>
      </div>
      <div class="font-bold">{{data?.startAmount }} - {{data?.endAmount}} USDC</div>
    </div>
    <hr class="bg-blue-25 h-1"/>
    <div class="py-8">
      <div class="flex items-center pl-4 pr-8">
        <img
          class="w-12 h-12"
          src="@/assets/triangle.png"
          alt="triangle"
        />
        <select class="border border-black rounded h-7 w-full" v-model="stakeData">
          <option
            v-for="(item, i) in data?.starkingReward"
            :key="i"
            :value="{duration:item?.duration, reward_rate:item?.reward_rate}"
          >
            {{item?.duration}} day ({{item?.minRewardRate}}% ~ {{item?.maxRewardRate}}%) 
          </option>
        </select>
      </div>

      <div class="flex items-center pl-4 pr-8" v-for="(item, i) in data?.descriptions" :key="i">
        <img
          class="w-12 h-12"
          src="@/assets/triangle.png"
          alt="triangle"
        />
        <div class="h-7">
          {{item}}
        </div>
      </div>
    </div>
    <hr class="bg-blue-25 h-1"/>
    <div class="p-4 space-y-4">
      <input type="number" class="w-full border rounded y-0.5 pl-4" placeholder="USDC Amount" v-model="amount">
      <button class="bg-red-25 w-full text-white rounded py-0.5" @click="stakeNow">Stake Now</button>
    </div>
    <div v-if="isModal" class="bg-red-100 flex flex-col justify-center items-center absolute z-20 px-8 py-4 rounded-xl top-36 font-bold mx-4">
      <div class="text-center">{{message}}</div>
      <button class="bg-red-300 rounded-full px-8 py-2 text-white mt-4" @click="isModal = !isModal">CONFIRM</button>
    </div>
  </div>
</template>
<script>
import { onMounted, computed, ref, reactive } from 'vue'
import { useStore } from 'vuex'
export default {
  setup () {
    const store = useStore()
    const stakeData = reactive({duration:3, reward_rate:0.7})
    const amount = ref(null)
    const isModal = ref(false)
    const message = ref('')
    onMounted(async () => {
      await store.dispatch('card/fetchCard')
    })
    const data = computed(() => store.getters['card/getSlideById'](1))
    const wallet = computed(() => store.getters['user/getUserAddress'])
    const stakeNow = async () => {
      let someDate = new Date();
      let result = someDate.setDate(someDate.getDate() + stakeData.duration);

      let payload = {
        ending_at: new Date(result),
        wallet: wallet.value,
        amount: amount.value,
        staking_option: data?.value._id,
        reward_rate: stakeData?.reward_rate,
        eth_amount: amount.value/ethPrice.value,
      }
      try {
        let res = await store.dispatch( 'card/createStake', payload )
        console.log("res", res)
        isModal.value = true
        message.value = "ðŸ˜Š Staking Success! Please  wait for network confirmation"
        
      } catch (error) {
        console.log("error", error)
        isModal.value = true
        message.value = "ðŸ˜’ Try Again! Please wait until staking finish"
      }
    }
    return { data, stakeNow, amount, stakeData, isModal, message }
  }
  };
</script>